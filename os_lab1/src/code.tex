\section{Исходная программа}

\subsection{Родительский процесс}

\begin{lstlisting}[language=C]
#include <stdio.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <string.h>

int main(void) {
    char filename[256];
    printf("Enter output filename: ");
    if (fgets(filename, sizeof(filename), stdin) == NULL) {
        fprintf(stderr, "Error reading filename\n");
        return 1;
    }

    // Remove newline character from filename
    size_t len = strlen(filename);
    if (len > 0 && filename[len - 1] == '\n') {
        filename[len - 1] = '\0';
    }

    int pipe_to_child[2];   // Send data to child process
    int pipe_from_child[2]; // Receive data from child process

    if (pipe(pipe_to_child) == -1) {
        perror("pipe");
        return 1;
    }
    if (pipe(pipe_from_child) == -1) {
        perror("pipe");
        return 1;
    }

    // Create child process
    pid_t pid = fork();
    if (pid < 0) {
        perror("fork");
        return 1;
    }

    if (pid == 0) {
        if (dup2(pipe_to_child[0], STDIN_FILENO) == -1) {
            perror("dup2 stdin");
            _exit(1);
        }
        if (dup2(pipe_from_child[1], STDOUT_FILENO) == -1) {
            perror("dup2 stdout");
            _exit(1);
        }

        // Close unused descriptors
        close(pipe_to_child[0]);
        close(pipe_to_child[1]);
        close(pipe_from_child[0]);
        close(pipe_from_child[1]);

        // Launch child
        execl("./child", "child", filename, (char *)NULL);
        perror("execl");
        _exit(1);
    } else {
        // Close unused pipe ends
        close(pipe_to_child[0]);
        close(pipe_from_child[1]);

        // Non-blocking mode for pipe
        fcntl(pipe_from_child[0], F_SETFL, O_NONBLOCK);

        char line[512];
        printf("Enter lines like: \"number number number\" (float). Empty line or EOF to exit.\n");

        while (1) {
            printf("> ");
            if (!fgets(line, sizeof(line), stdin)) {
                break;
            }

            if (strcmp(line, "\n") == 0) {
                break;
            }

            // Send line to child process
            if (write(pipe_to_child[1], line, strlen(line)) == -1) {
                perror("write to child");
                break;
            }
        }

        // Close pipe and wait for child process
        close(pipe_to_child[1]);
        close(pipe_from_child[0]);

        int status;
        waitpid(pid, &status, 0);
        printf("Parent process finished.\n");
    }

    return 0;
}
\end{lstlisting}

\subsection{Дочерний процесс}

\begin{lstlisting}[language=C]
#include <stdio.h>
#include <stdlib.h>

int main(int argc, char *argv[]) {

    const char *filename = argv[1];
    FILE *out = fopen(filename, "w");
    if (!out) {
        perror("fopen output file");
        return 1;
    }

    // Read lines from stdin
    char line[512];
    while (fgets(line, sizeof(line), stdin)) {
        float numbers[128];
        int count = 0;
        char *ptr = line;
        char *endptr;

        while (*ptr != '\0') {
            // Skip spaces
            while (*ptr == ' ' || *ptr == '\t') {
                ptr++;
            }
            if (*ptr == '\0' || *ptr == '\n')
                break;

            // Convert string to number
            float value = strtof(ptr, &endptr);
            if (ptr == endptr) {
                break;
            }
            if (count < (int)(sizeof(numbers) / sizeof(numbers[0]))) {
                numbers[count++] = value;
            }
            ptr = endptr;
        }

        if (count <= 0) {
            continue;
        }

        // Calculate division result
        float result = numbers[0];
        for (int i = 1; i < count; ++i) {
            // Check for division by zero
            if (numbers[i] == 0.0f) {
                const char *msg = "Division by 0. Exit.\n";
                fprintf(out, "Input numbers: %sError: division by zero\n\n", line);
                fflush(out);
                fputs(msg, stdout);
                fflush(stdout);
                fclose(out);
                return 0;
            }
            result /= numbers[i];
        }

        // Write result to file
        fprintf(out, "Input numbers: %sResult: %f\n\n", line, result);
        fflush(out);
    }

    fclose(out);
    return 0;
}
\end{lstlisting}
